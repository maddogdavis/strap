#!/bin/bash -euf

. _strap__inc

check_args $# 2 "<dir> <tmp>"

work=$1
tmp=$2

date=`date '+%Y%m%d_%H%M'`
rescue="${tmp}/git_rescue_${date}"
load="${tmp}/git_load_${date}"

check_file d y ${work}
check_file d y ${tmp}
check_file d n ${rescue}
check_file d n ${load}

mkdir "${load}"
echo "attempting reload into ${load}..."

strap--git-recurse ${work} "status"

git__tree_repos ${work}
for i in ${__}
do
  git__get_repo_loc ${work}/${i} && url=${__}
  target=${load}/${i}
  git_clone ${url} ${load}/${i}
done

mkdir "${rescue}"

set +f

echo "moving ${work} entries to ${rescue}..."
mv ${work}/* ${rescue}

echo "moving reloaded entries ${load} to ${work}..."
mv ${load}/* ${work}

set -f

echo "git rescue complete"
